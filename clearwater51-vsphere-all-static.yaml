tosca_definitions_version: cloudify_dsl_1_3

########################################################

imports:
  - http://www.getcloudify.org/spec/cloudify/3.4/types.yaml
  - http://www.getcloudify.org/spec/vsphere-plugin/2.0/plugin.yaml
  - http://www.getcloudify.org/spec/diamond-plugin/1.3.3/plugin.yaml
  - types/clearwater-monitoring.yaml
  - types/clearwater.yaml
  - types/vsphere.yaml
#  - types/policy.yaml
  - types/snmp.yaml
  - types/bind.yaml

inputs:

########################################################
#  vSphere connection config
########################################################

    vsphere_username:
        default: "administrator@vsphere.local"
    
    vsphere_password:
        default: ""
    
    vsphere_host:
        default: ""
    
    vsphere_port:
        default: 443
    
    vsphere_datacenter:
        default: "Datacenter"
    
    vsphere_resource_pool_name:
        default: "Resources"
    
    vsphere_auto_placement:
        type: boolean
        default: false

    private_domain:
        default: clearwater.local

    public_domain:
        default: example.com

########################################################
# VMs parameters
########################################################

    agent_user:
        default:  'ubuntu'
        description: >
            User for connecting to application VMs
    agent_key_file:
        default: '~/.ssh/agent.pem'

    template_name:
        default: "ubuntu-14.04.5-x86_64-tmpl"
        description: >
            Template to clone VMs from

    vm_cpu:
        default: 2
    
    vm_memory:
        default: 2048
        
########################################################
# Network parameters
########################################################        
    network:
        default: "VM Network"

    switch_distributed:
        type: boolean
        default: false

    ellis_ip:
        default: "10.10.111.101"

    bono_ip:
        default: "10.10.111.108" #

    sprout_ip:
        default: "10.10.111.109" #

    homer_ip:
        default: "10.10.111.104"

    homestead_ip:
        default: "10.10.111.105"

    ralf_ip:
        default: "10.10.111.106"

    dns_ip:
        default: "10.10.111.107"

    gateway_ip:
        default: "10.10.111.1"

    network_ip:
        default: "10.10.111.0/24"

    dns_servers:
        default: 
            - 8.8.8.8
            - 8.8.4.4
########################################################

dsl_definitions:
    connection_config: &connection_config
        username: { get_input: vsphere_username }
        password: { get_input: vsphere_password }
        host: { get_input: vsphere_host }
        port: { get_input: vsphere_port }
        datacenter_name: { get_input: vsphere_datacenter }
        resource_pool_name: { get_input: vsphere_resource_pool_name }
        auto_placement: { get_input: vsphere_auto_placement }

########################################################

node_templates:
#    a_node:
#        type: cloudify.nodes.Compute
#        properties:
#           install_agent: false
#
#    policy_node:
#        type: policy_node_type
#        relationships:
#           - target: bono-vm
#             type: cloudify.relationships.depends_on
#           - target: sprout-vm
#             type: cloudify.relationships.depends_on
#           - target: a_node
#             type: cloudify.relationships.contained_in
#        properties:
#           nodes_to_monitor:
#              - bono-vm
#              - sprout-vm

    bono_vm:
        type: clearwater.nodes.MonitoredServer
        properties:
            networking:
                dns_servers: { get_input: dns_servers }
                connect_networks:
                    - name: { get_input: network }
                      switch_distributed: { get_input: switch_distributed }
                      management: True
                      external: True
                      use_dhcp: False                      
                      ip: { get_input: bono_ip }
                      gateway: { get_input: gateway_ip }
                      network: { get_input: network_ip }
            connection_config: *connection_config

        relationships:
           - target: homestead_vm
             type: cloudify.relationships.depends_on

    ellis_vm:
        type: clearwater.nodes.MonitoredServer
        properties:
            networking:
                dns_servers: { get_input: dns_servers }
                connect_networks:
                    - name: { get_input: network }
                      switch_distributed: { get_input: switch_distributed }
                      management: True
                      external: True
                      use_dhcp: False                      
                      ip: { get_input: ellis_ip }
                      gateway: { get_input: gateway_ip }
                      network: { get_input: network_ip }
            connection_config: *connection_config
        relationships:
            - target: bono_vm
              type: cloudify.relationships.depends_on

    sprout_vm:
        type: clearwater.nodes.MonitoredServer
        properties:
            networking:
                dns_servers: { get_input: dns_servers }
                connect_networks:
                    - name: { get_input: network }
                      switch_distributed: { get_input: switch_distributed }
                      management: True
                      external: True
                      use_dhcp: False                      
                      ip: { get_input: sprout_ip }
                      gateway: { get_input: gateway_ip }
                      network: { get_input: network_ip }
            connection_config: *connection_config
        relationships:
           - target: homer_vm
             type: cloudify.relationships.depends_on
           - target: homestead_vm
             type: cloudify.relationships.depends_on

    homer_vm:
        type: clearwater.nodes.MonitoredServer
        properties:
            networking:
                dns_servers: { get_input: dns_servers }
                connect_networks:
                    - name: { get_input: network }
                      switch_distributed: { get_input: switch_distributed }
                      management: True
                      external: True
                      use_dhcp: False                      
                      ip: { get_input: homer_ip }
                      gateway: { get_input: gateway_ip }
                      network: { get_input: network_ip }
            connection_config: *connection_config

    homestead_vm:
        type: clearwater.nodes.MonitoredServer
        properties:
            networking:
                dns_servers: { get_input: dns_servers }
                connect_networks:
                    - name: { get_input: network }
                      switch_distributed: { get_input: switch_distributed }
                      management: True
                      external: True
                      use_dhcp: False                      
                      ip: { get_input: homestead_ip }
                      gateway: { get_input: gateway_ip }
                      network: { get_input: network_ip }
            connection_config: *connection_config

    ralf_vm:
        type: clearwater.nodes.MonitoredServer
        properties:
            networking:
                dns_servers: { get_input: dns_servers }
                connect_networks:
                    - name: { get_input: network }
                      switch_distributed: { get_input: switch_distributed }
                      management: True
                      external: True
                      use_dhcp: False                      
                      ip: { get_input: ralf_ip }
                      gateway: { get_input: gateway_ip }
                      network: { get_input: network_ip }
            connection_config: *connection_config

    bind_host:
        type: clearwater.nodes.MonitoredServer
        properties:
            networking:
                dns_servers: { get_input: dns_servers }
                connect_networks:
                    - name: { get_input: network }
                      switch_distributed: { get_input: switch_distributed }
                      management: True
                      external: True
                      use_dhcp: False                      
                      ip: { get_input: dns_ip }
                      gateway: { get_input: gateway_ip }
                      network: { get_input: network_ip }
            connection_config: *connection_config

########################################################
########################################################
    bono:
        type: clearwater.nodes.bono
        properties:
          private_domain: { get_input: private_domain }
        relationships:
            -  type: cloudify.relationships.contained_in
               target: bono_vm
            -  type: app_connected_to_bind
               target: bind

    ellis:
        type: clearwater.nodes.ellis
        properties:
            private_domain: { get_input: private_domain }
        relationships:
            -  type: cloudify.relationships.contained_in
               target: ellis_vm
            -  type: app_connected_to_bind_ellis
               target: bind

    ralf:
        type: clearwater.nodes.ralf
        properties:
            private_domain: { get_input: private_domain }
        relationships:
            -  type: cloudify.relationships.contained_in
               target: ralf_vm
            -  type: app_connected_to_bind
               target: bind

    homestead:
        type: clearwater.nodes.homestead
        properties:
            private_domain: { get_input: private_domain }
        relationships:
            -  type: cloudify.relationships.contained_in
               target: homestead_vm
            -  type: app_connected_to_bind
               target: bind

    homer:
        type: clearwater.nodes.homer
        properties:
            private_domain: { get_input: private_domain }
        relationships:
            -  type: cloudify.relationships.contained_in
               target: homer_vm
            -  type: app_connected_to_bind
               target: bind

    sprout:
        type: clearwater.nodes.sprout
        properties:
            private_domain: { get_input: private_domain }
        relationships:
            -  type: cloudify.relationships.contained_in
               target: sprout_vm
            -  type: app_connected_to_bind
               target: bind

    bind:
        type: clearwater.infra.bind
        properties:
            private_domain: { get_input: private_domain }
            public_domain: { get_input: public_domain }
            secret_code: secret
        relationships:
            -  type: cloudify.relationships.contained_in
               target: bind_host

    proxy_node:
      type: SNMPManagerProxy
      relationships:
        - type: monitors_bono_nodes
          target: bono
        - type: monitors_sprout_nodes
          target: sprout

########################################################

outputs:
  web:
    description: Web application endpoint
    value:
      ip_ellis: { get_attribute: [ ellis_vm, public_ip ] }
      ip_bono: { get_attribute: [ bono_vm, public_ip ] }
      signup_code: secret
